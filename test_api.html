<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tattva Astrology API Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            display: none;
        }
        
        .result.active {
            display: block;
        }
        
        .result h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .result-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .result-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .result-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .yoga-list {
            list-style: none;
        }
        
        .yoga-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        
        .yoga-name {
            font-weight: 600;
            color: #667eea;
        }
        
        .error {
            padding: 20px;
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 10px;
            color: #c33;
            margin-top: 20px;
            display: none;
        }
        
        .error.active {
            display: block;
        }
        
        .example-data {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .example-data p {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .example-btn {
            display: inline-block;
            padding: 5px 15px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-size: 14px;
            margin-top: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü Tattva Astrology</h1>
            <p>Complete Vedic Astrology Profile Generator</p>
        </div>
        
        <div class="content">
            <div class="example-data">
                <strong>üìù Example Test Data:</strong>
                <p>Name: John Doe | Date: 1990-05-15 | Time: 14:30 | Place: Mumbai</p>
                <span class="example-btn" onclick="fillExample()">Use Example Data</span>
            </div>
            
            <div class="example-data" style="background: #e8f5e9;">
                <strong>üíæ Saved Profiles:</strong>
                <select id="savedProfiles" style="width: 70%; padding: 5px; margin: 10px 0; border-radius: 5px;">
                    <option value="">-- Select a saved profile --</option>
                </select>
                <span class="example-btn" onclick="loadProfile()" style="background: #4caf50;">Load</span>
                <span class="example-btn" onclick="deleteProfile()" style="background: #f44336; margin-left: 5px;">Delete</span>
            </div>
            
            <form id="birthForm">
                <div class="form-group">
                    <label for="name">üë§ Full Name</label>
                    <input type="text" id="name" placeholder="e.g., John Doe" required>
                </div>
                
                <div class="form-group">
                    <label for="birth_date">üìÖ Birth Date</label>
                    <input type="date" id="birth_date" required>
                </div>
                
                <div class="form-group">
                    <label for="birth_time">üïê Birth Time (24-hour format)</label>
                    <input type="time" id="birth_time" required>
                </div>
                
                <div class="form-group">
                    <label for="birth_place">üìç Birth Place</label>
                    <input type="text" id="birth_place" placeholder="e.g., Mumbai, London, New York" required>
                </div>
                
                <button type="submit" id="submitBtn">Generate Astrological Profile</button>
                <button type="button" onclick="saveProfile()" style="margin-top: 10px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">üíæ Save This Profile</button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Calculating your cosmic blueprint...</p>
            </div>
            
            <div class="error" id="error"></div>
            
            <div class="result" id="result">
                <h2>Your Astrological Profile</h2>
                
                <div class="result-section">
                    <h3>üé≠ Executive Summary</h3>
                    <p id="personality"></p>
                    <p><strong>Active Yogas:</strong> <span id="yogas_count"></span></p>
                    <p><strong>Current Dasa Planet:</strong> <span id="dasa_planet"></span></p>
                    <p><strong>Life Stage:</strong> <span id="life_stage"></span></p>
                </div>
                
                <div class="result-section">
                    <h3>üåô Birth Chart</h3>
                    <p><strong>Lagna (Ascendant):</strong> <span id="lagna"></span> at <span id="lagna_degree"></span>¬∞</p>
                    <p><strong>Sun Sign:</strong> <span id="sun_sign"></span> in <span id="sun_nakshatra"></span></p>
                    <p><strong>Moon Sign:</strong> <span id="moon_sign"></span> in <span id="moon_nakshatra"></span></p>
                    <p><strong>Moon Nakshatra:</strong> <span id="moon_nakshatra_detail"></span></p>
                    <p><strong>Moon Pada:</strong> <span id="moon_pada"></span></p>
                </div>
                
                <div class="result-section">
                    <h3>üìä Divisional Charts (Shodashvarga - All 20 Charts)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
                        <!-- D1 - Rasi -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">üè† D1 - Rasi (Birth Chart)</h4>
                            <div id="house_chart_d1" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D2 - Hora -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üí∞ D2 - Hora</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Wealth & Finances</p>
                            <div id="house_chart_d2" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D3 - Drekkana -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üë®‚Äçüë©‚Äçüëß D3 - Drekkana</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Siblings & Courage</p>
                            <div id="house_chart_d3" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D4 - Chaturthamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üè° D4 - Chaturthamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Property & Fortune</p>
                            <div id="house_chart_d4" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D5 - Panchamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üåü D5 - Panchamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Spiritual Merit & Fame</p>
                            <div id="house_chart_d5" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D6 - Shashtamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üè• D6 - Shashtamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Health & Enemies</p>
                            <div id="house_chart_d6" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D7 - Saptamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üë∂ D7 - Saptamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Children & Progeny</p>
                            <div id="house_chart_d7" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D8 - Ashtamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">‚ö†Ô∏è D8 - Ashtamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Longevity & Sudden Events</p>
                            <div id="house_chart_d8" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D9 - Navamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üíë D9 - Navamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Marriage & Spouse</p>
                            <div id="house_chart_d9" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D10 - Dasamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üíº D10 - Dasamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Career & Profession</p>
                            <div id="house_chart_d10" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D11 - Ekadasamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üéØ D11 - Ekadasamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">General Prosperity</p>
                            <div id="house_chart_d11" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D12 - Dwadasamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üë®‚Äçüë©‚Äçüë¶ D12 - Dwadasamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Parents</p>
                            <div id="house_chart_d12" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D16 - Shodasamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üöó D16 - Shodasamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Vehicles & Comforts</p>
                            <div id="house_chart_d16" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D20 - Vimsamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üôè D20 - Vimsamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Spiritual Progress</p>
                            <div id="house_chart_d20" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D24 - Chaturvimsamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üìö D24 - Chaturvimsamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Education & Learning</p>
                            <div id="house_chart_d24" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D27 - Bhamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üí™ D27 - Bhamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Strength & Weakness</p>
                            <div id="house_chart_d27" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D30 - Trimsamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üòà D30 - Trimsamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Evils & Misfortunes</p>
                            <div id="house_chart_d30" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D40 - Khavedamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üë© D40 - Khavedamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Maternal Legacy</p>
                            <div id="house_chart_d40" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D45 - Akshavedamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üë® D45 - Akshavedamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Paternal Legacy</p>
                            <div id="house_chart_d45" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                        
                        <!-- D60 - Shashtiamsa -->
                        <div style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: white;">
                            <h4 style="color: #667eea; margin-bottom: 5px;">üîÆ D60 - Shashtiamsa</h4>
                            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">Past Life Karma</p>
                            <div id="house_chart_d60" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3>‚≠ê Active Yogas</h3>
                    <ul class="yoga-list" id="yoga_list"></ul>
                </div>
                
                <div class="result-section">
                    <h3>üéØ Ashtakavarga - Transit Scoring System</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        Ashtakavarga predicts transit quality for each sign based on benefic points. 
                        Higher scores indicate favorable transits, while lower scores suggest challenges.
                    </p>
                    
                    <!-- SAV - Total Points Chart -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 15px;">üìä Sarvashtakavarga (SAV) - Total Points</h4>
                        <div id="sav_chart" style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 8px; text-align: center;"></div>
                        <p style="margin-top: 10px; font-size: 12px; color: #666;">
                            üü¢ 28+ = Excellent | üü° 25-27 = Good | üü† 22-24 = Average | üî¥ <22 = Challenging
                        </p>
                    </div>
                    
                    <!-- BAV - Individual Planet Charts -->
                    <div>
                        <h4 style="color: #667eea; margin-bottom: 15px;">‚≠ê Bhinnashtakavarga (BAV) - Planet-wise Points</h4>
                        <div id="bav_tables" style="overflow-x: auto;"></div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3>‚è≥ Vimshottari Dasa Schedule - Planetary Periods</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        Complete 120-year timeline showing all Maha Dasas (major periods) and Bhuktis (sub-periods). 
                        Each planet rules for a specific duration, influencing life events during its period.
                    </p>
                    
                    <!-- Current Dasa Highlight -->
                    <div id="current_dasa_highlight" style="padding: 15px; background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;"></div>
                    
                    <!-- Full Timeline -->
                    <div id="dasa_timeline"></div>
                </div>
                
                <div class="result-section">
                    <h3>üé≠ Functional Nature of Planets</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        Each planet becomes benefic, malefic, or neutral based on which houses it rules from your ascendant. 
                        This determines whether the planet helps or hinders during its period.
                    </p>
                    <div id="functional_nature"></div>
                </div>
                
                <div class="result-section">
                    <h3>üí™ Shadbala - Planetary Strength</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        Six-fold strength measurement in Rupas (units). Planets above required strength give better results.
                        Strong planets can deliver their promises, weak ones struggle.
                    </p>
                    <div id="shadbala"></div>
                </div>
                
                <div class="result-section">
                    <h3>üî¢ Numerology</h3>
                    <p id="numerology"></p>
                </div>
                
                <div class="result-section">
                    <h3>üìä Complete Summary</h3>
                    <div id="readable_summary"></div>
                </div>
                
                <div class="result-section">
                    <h3>üíª Raw JSON Response</h3>
                    <details>
                        <summary style="cursor: pointer; color: #667eea; font-weight: 600;">View Full Response</summary>
                        <button onclick="copyJsonToClipboard()" style="margin: 10px 0; padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            üìã Copy JSON
                        </button>
                        <pre id="raw_json" style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; margin-top: 10px;"></pre>
                    </details>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://tattva-api-387275429365.us-central1.run.app/api/v1/profile/complete';
        
        // Load saved profiles on page load
        window.onload = function() {
            loadSavedProfilesList();
        };
        
        function loadSavedProfilesList() {
            try {
                const select = document.getElementById('savedProfiles');
                if (!select) {
                    console.error('savedProfiles select element not found');
                    return;
                }
                
                select.innerHTML = '<option value="">-- Select a saved profile --</option>';
                
                const profilesJson = localStorage.getItem('astroProfiles') || '{}';
                console.log('Loading profiles from localStorage:', profilesJson);
                
                const profiles = JSON.parse(profilesJson);
                
                if (profiles && typeof profiles === 'object') {
                    const keys = Object.keys(profiles);
                    console.log(`Found ${keys.length} saved profiles:`, keys);
                    
                    keys.forEach(key => {
                        const profile = profiles[key];
                        if (profile && profile.name) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = `${key}: ${profile.name}`;
                            select.appendChild(option);
                        } else {
                            console.warn(`Profile "${key}" has invalid data:`, profile);
                        }
                    });
                } else {
                    console.log('No profiles found or invalid data');
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                alert('Error loading saved profiles: ' + error.message);
            }
        }
        
        function saveProfile() {
            try {
                const name = document.getElementById('name').value;
                const birth_date = document.getElementById('birth_date').value;
                const birth_time = document.getElementById('birth_time').value;
                const birth_place = document.getElementById('birth_place').value;
                
                if (!name || !birth_date || !birth_time || !birth_place) {
                    alert('Please fill all fields before saving!');
                    return;
                }
                
                const profileName = prompt('Enter profile name (e.g., Profile 1, Mom, Dad):', 'Profile 1');
                if (!profileName) return;
                
                const profiles = JSON.parse(localStorage.getItem('astroProfiles') || '{}');
                profiles[profileName] = {
                    name: name,
                    birth_date: birth_date,
                    birth_time: birth_time,
                    birth_place: birth_place,
                    saved_at: new Date().toISOString()
                };
                
                console.log('Saving profile:', profileName, profiles[profileName]);
                localStorage.setItem('astroProfiles', JSON.stringify(profiles));
                loadSavedProfilesList();
                alert(`Profile "${profileName}" saved successfully!`);
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile: ' + error.message);
            }
        }
        
        function loadProfile() {
            try {
                const select = document.getElementById('savedProfiles');
                const profileName = select.value;
                
                if (!profileName) {
                    alert('Please select a profile to load!');
                    return;
                }
                
                const profiles = JSON.parse(localStorage.getItem('astroProfiles') || '{}');
                const profile = profiles[profileName];
                
                console.log('Loading profile:', profileName, profile);
                
                if (profile) {
                    if (profile.name) document.getElementById('name').value = profile.name;
                    if (profile.birth_date) document.getElementById('birth_date').value = profile.birth_date;
                    if (profile.birth_time) document.getElementById('birth_time').value = profile.birth_time;
                    if (profile.birth_place) document.getElementById('birth_place').value = profile.birth_place;
                    alert(`Profile "${profileName}" loaded!`);
                } else {
                    alert(`Profile "${profileName}" not found!`);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Error loading profile: ' + error.message);
            }
        }
        
        function deleteProfile() {
            try {
                const select = document.getElementById('savedProfiles');
                const profileName = select.value;
                
                if (!profileName) {
                    alert('Please select a profile to delete!');
                    return;
                }
                
                if (!confirm(`Are you sure you want to delete "${profileName}"?`)) {
                    return;
                }
                
                const profiles = JSON.parse(localStorage.getItem('astroProfiles') || '{}');
                console.log('Deleting profile:', profileName);
                delete profiles[profileName];
                localStorage.setItem('astroProfiles', JSON.stringify(profiles));
                loadSavedProfilesList();
                alert(`Profile "${profileName}" deleted!`);
            } catch (error) {
                console.error('Error deleting profile:', error);
                alert('Error deleting profile: ' + error.message);
            }
        }
        
        function fillExample() {
            try {
                console.log('Filling example data...');
                
                const nameField = document.getElementById('name');
                const dateField = document.getElementById('birth_date');
                const timeField = document.getElementById('birth_time');
                const placeField = document.getElementById('birth_place');
                
                if (!nameField || !dateField || !timeField || !placeField) {
                    console.error('One or more form fields not found');
                    alert('Error: Form fields not found');
                    return;
                }
                
                nameField.value = 'John Doe';
                dateField.value = '1990-05-15';
                timeField.value = '14:30';
                placeField.value = 'Mumbai';
                
                console.log('Example data filled successfully');
            } catch (error) {
                console.error('Error filling example data:', error);
                alert('Error filling example data: ' + error.message);
            }
        }
        
        function copyJsonToClipboard() {
            const jsonText = document.getElementById('raw_json').textContent;
            
            navigator.clipboard.writeText(jsonText).then(() => {
                // Show success feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }
        
        document.getElementById('birthForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Hide previous results
            document.getElementById('result').classList.remove('active');
            document.getElementById('error').classList.remove('active');
            
            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('submitBtn').disabled = true;
            
            // Collect form data
            const data = {
                name: document.getElementById('name').value,
                birth_date: document.getElementById('birth_date').value,
                birth_time: document.getElementById('birth_time').value,
                birth_place: document.getElementById('birth_place').value
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayResult(result);
                } else {
                    throw new Error(result.detail || 'API request failed');
                }
            } catch (error) {
                displayError(error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('submitBtn').disabled = false;
            }
        });
        
        function displayResult(result) {
            console.log('Received result:', result);
            console.log('Available top-level keys:', Object.keys(result));
            
            // Executive Summary
            if (result.executive_summary) {
                document.getElementById('personality').textContent = result.executive_summary.personality_overview || 'N/A';
                document.getElementById('yogas_count').textContent = result.executive_summary.active_yogas_count || '0';
                document.getElementById('dasa_planet').textContent = result.executive_summary.current_dasa_planet || 'N/A';
                document.getElementById('life_stage').textContent = result.executive_summary.life_stage || 'N/A';
            }
            
            // Birth Chart
            if (result.birth_chart) {
                if (result.birth_chart.lagna) {
                    document.getElementById('lagna').textContent = result.birth_chart.lagna.rasi || 'N/A';
                    document.getElementById('lagna_degree').textContent = result.birth_chart.lagna.longitude ? result.birth_chart.lagna.longitude.toFixed(2) : 'N/A';
                }
                
                if (result.birth_chart.planets && Array.isArray(result.birth_chart.planets)) {
                    const sunPlanet = result.birth_chart.planets.find(p => p.planet === 'Sun');
                    const moonPlanet = result.birth_chart.planets.find(p => p.planet === 'Moon');
                    
                    document.getElementById('sun_sign').textContent = sunPlanet ? sunPlanet.rasi : 'N/A';
                    document.getElementById('sun_nakshatra').textContent = sunPlanet ? sunPlanet.nakshatra : 'N/A';
                    
                    document.getElementById('moon_sign').textContent = moonPlanet ? moonPlanet.rasi : 'N/A';
                    document.getElementById('moon_nakshatra').textContent = moonPlanet ? moonPlanet.nakshatra : 'N/A';
                    document.getElementById('moon_nakshatra_detail').textContent = moonPlanet ? moonPlanet.nakshatra : 'N/A';
                    document.getElementById('moon_pada').textContent = moonPlanet ? moonPlanet.pada : 'N/A';
                }
                
                // Display all divisional charts
                displayHouseChart(result.birth_chart, 'd1');
                displayHouseChart(result.birth_chart, 'd2');
                displayHouseChart(result.birth_chart, 'd3');
                displayHouseChart(result.birth_chart, 'd4');
                displayHouseChart(result.birth_chart, 'd5');
                displayHouseChart(result.birth_chart, 'd6');
                displayHouseChart(result.birth_chart, 'd7');
                displayHouseChart(result.birth_chart, 'd8');
                displayHouseChart(result.birth_chart, 'd9');
                displayHouseChart(result.birth_chart, 'd10');
                displayHouseChart(result.birth_chart, 'd11');
                displayHouseChart(result.birth_chart, 'd12');
                displayHouseChart(result.birth_chart, 'd16');
                displayHouseChart(result.birth_chart, 'd20');
                displayHouseChart(result.birth_chart, 'd24');
                displayHouseChart(result.birth_chart, 'd27');
                displayHouseChart(result.birth_chart, 'd30');
                displayHouseChart(result.birth_chart, 'd40');
                displayHouseChart(result.birth_chart, 'd45');
                displayHouseChart(result.birth_chart, 'd60');
            }
            
            // Active Yogas
            if (result.yogas && Array.isArray(result.yogas)) {
                const activeYogas = result.yogas.filter(y => y.present);
                const yogaList = document.getElementById('yoga_list');
                yogaList.innerHTML = '';
                
                activeYogas.slice(0, 5).forEach(yoga => {
                    const li = document.createElement('li');
                    li.className = 'yoga-item';
                    li.innerHTML = `
                        <span class="yoga-name">${yoga.name}</span> (${yoga.nature})
                        <br><small>${yoga.description}</small>
                    `;
                    yogaList.appendChild(li);
                });
                
                if (activeYogas.length === 0) {
                    yogaList.innerHTML = '<li class="yoga-item">No active yogas found</li>';
                }
            }
            
            // Ashtakavarga Display
            if (result.ashtakavarga) {
                displayAshtakavarga(result.ashtakavarga);
            }
            
            // Dasa Schedule Display
            console.log('Checking for dasa_periods:', result.dasa_periods);
            console.log('dasa_periods type:', typeof result.dasa_periods);
            if (result.dasa_periods && typeof result.dasa_periods === 'object') {
                console.log('dasa_periods keys:', Object.keys(result.dasa_periods));
            }
            
            if (result.dasa_periods) {
                if (result.dasa_periods.full_schedule) {
                    console.log('Displaying dasa schedule with full_schedule:', result.dasa_periods);
                    displayDasaSchedule(result.dasa_periods.full_schedule, result.dasa_periods);
                } else if (result.dasa_periods.maha_dasas) {
                    // If the API returns maha_dasas directly
                    console.log('Displaying dasa schedule directly from dasa_periods:', result.dasa_periods);
                    displayDasaSchedule(result.dasa_periods, result.dasa_periods);
                } else {
                    console.log('dasa_periods exists but structure not recognized:', result.dasa_periods);
                    document.getElementById('current_dasa_highlight').innerHTML = `
                        <p style="color: #f44336;">Dasa periods data format not recognized.</p>
                        <p style="color: #666; font-size: 12px; margin-top: 8px;">Available keys: ${Object.keys(result.dasa_periods || {}).join(', ')}</p>
                        <p style="color: #666; font-size: 12px;">Check browser console for details.</p>
                    `;
                }
            } else {
                console.log('No dasa_periods data found in result');
                console.log('Available data keys:', Object.keys(result));
                document.getElementById('current_dasa_highlight').innerHTML = `
                    <p style="color: #666;">No Dasa periods data available from API.</p>
                    <p style="color: #666; font-size: 12px; margin-top: 8px;">The API response did not include dasa_periods.</p>
                    <p style="color: #666; font-size: 12px;">Available data: ${Object.keys(result).join(', ')}</p>
                `;
            }
            
            // Functional Nature Display
            if (result.functional_nature) {
                console.log('Displaying functional nature:', result.functional_nature);
                displayFunctionalNature(result.functional_nature);
                if (result.functional_nature_detailed) {
                    console.log('Displaying detailed functional nature:', result.functional_nature_detailed);
                    displayFunctionalNatureDetailed(result.functional_nature_detailed);
                }
            }
            
            // Shadbala Display
            if (result.shadbala) {
                console.log('Displaying shadbala:', result.shadbala);
                displayShadbala(result.shadbala);
            }
            
            // Numerology
            if (result.numerology) {
                const birthNum = result.numerology.birth_number || {};
                const destinyNum = result.numerology.destiny_number || {};
                const nameNum = result.numerology.name_number || {};
                
                document.getElementById('numerology').innerHTML = `
                    <strong>Birth Number:</strong> ${birthNum.number || 'N/A'} (${birthNum.planet || 'N/A'})<br>
                    <strong>Meaning:</strong> ${birthNum.meaning || 'N/A'}<br>
                    <strong>Destiny Number:</strong> ${destinyNum.number || 'N/A'} (${destinyNum.planet || 'N/A'})<br>
                    <strong>Meaning:</strong> ${destinyNum.meaning || 'N/A'}<br>
                    <strong>Name Number:</strong> ${nameNum.number || 'N/A'} (Root: ${nameNum.root || 'N/A'}, Planet: ${nameNum.planet || 'N/A'})<br>
                    ${result.numerology.lucky_numbers && Array.isArray(result.numerology.lucky_numbers) ? `<strong>Lucky Numbers:</strong> ${result.numerology.lucky_numbers.join(', ')}<br>` : ''}
                    ${result.numerology.lucky_days && Array.isArray(result.numerology.lucky_days) ? `<strong>Lucky Days:</strong> ${result.numerology.lucky_days.join(', ')}<br>` : ''}
                    ${result.numerology.lucky_colors && Array.isArray(result.numerology.lucky_colors) ? `<strong>Lucky Colors:</strong> ${result.numerology.lucky_colors.join(', ')}` : ''}
                `;
            }
            
            // Raw JSON
            document.getElementById('raw_json').textContent = JSON.stringify(result, null, 2);
            
            // Readable Summary
            generateReadableSummary(result);
            
            // Show result
            document.getElementById('result').classList.add('active');
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }
        
        function displayError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.classList.add('active');
        }
        
        function displayAshtakavarga(ashtakavarga) {
            const signs = ['Ari', 'Tau', 'Gem', 'Can', 'Leo', 'Vir', 'Lib', 'Sco', 'Sag', 'Cap', 'Aqu', 'Pis'];
            const signsFull = ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn', 'Aquarius', 'Pisces'];
            const planets = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn'];
            
            // Display SAV (Total Points) Chart
            const savChart = document.getElementById('sav_chart');
            savChart.innerHTML = '';
            
            ashtakavarga.sav.total_points.forEach((points, index) => {
                const signDiv = document.createElement('div');
                let bgColor = '#ef4444'; // Red for <22
                if (points >= 28) bgColor = '#10b981'; // Green for 28+
                else if (points >= 25) bgColor = '#f59e0b'; // Yellow for 25-27
                else if (points >= 22) bgColor = '#fb923c'; // Orange for 22-24
                
                signDiv.style.cssText = `
                    background: ${bgColor};
                    color: white;
                    padding: 12px 8px;
                    border-radius: 8px;
                    font-weight: 600;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                signDiv.innerHTML = `
                    <div style="font-size: 12px; margin-bottom: 4px;">${signs[index]}</div>
                    <div style="font-size: 18px;">${points}</div>
                `;
                signDiv.title = `${signsFull[index]}: ${points} points`;
                savChart.appendChild(signDiv);
            });
            
            // Display BAV (Planet-wise) Tables
            const bavTables = document.getElementById('bav_tables');
            bavTables.innerHTML = '';
            
            planets.forEach(planet => {
                const planetKey = planet.toLowerCase();
                const planetData = ashtakavarga.bav[planetKey];
                if (!planetData) return;
                
                const table = document.createElement('table');
                table.style.cssText = `
                    width: 100%;
                    margin-bottom: 20px;
                    border-collapse: collapse;
                    background: white;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                // Header row
                const headerRow = document.createElement('tr');
                headerRow.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;';
                headerRow.innerHTML = `<th style="padding: 12px; text-align: left; font-weight: 600;">${planet}</th>` +
                    signs.map(sign => `<th style="padding: 12px; text-align: center; font-weight: 600; font-size: 11px;">${sign}</th>`).join('');
                table.appendChild(headerRow);
                
                // Data row
                const dataRow = document.createElement('tr');
                dataRow.innerHTML = '<td style="padding: 12px; font-weight: 600; color: #667eea;">Points</td>' +
                    planetData.map(points => {
                        let color = '#ef4444'; // Red for low
                        if (points >= 5) color = '#10b981'; // Green for high
                        else if (points >= 4) color = '#f59e0b'; // Yellow for medium
                        else if (points >= 3) color = '#fb923c'; // Orange for below avg
                        
                        return `<td style="padding: 12px; text-align: center; font-weight: 600; color: ${color}; font-size: 16px;">${points}</td>`;
                    }).join('');
                table.appendChild(dataRow);
                
                bavTables.appendChild(table);
            });
        }
        
        function displayDasaSchedule(schedule, currentDasa) {
            console.log('displayDasaSchedule called with:', { schedule, currentDasa });
            
            const timeline = document.getElementById('dasa_timeline');
            const currentHighlight = document.getElementById('current_dasa_highlight');
            
            if (!timeline) {
                console.error('Timeline element not found');
                return;
            }
            
            if (!schedule) {
                console.error('No schedule data provided');
                timeline.innerHTML = '<p style="color: #f44336;">No schedule data available.</p>';
                return;
            }
            
            if (!schedule.maha_dasas || !Array.isArray(schedule.maha_dasas)) {
                console.error('Invalid schedule data - maha_dasas missing or not an array:', schedule);
                timeline.innerHTML = '<p style="color: #f44336;">Schedule data format is invalid. maha_dasas is missing or not an array.</p>';
                return;
            }
            
            const planetEmojis = {
                'Sun': '‚òâ', 'Moon': '‚òΩ', 'Mars': '‚ôÇ', 'Mercury': '‚òø',
                'Jupiter': '‚ôÉ', 'Venus': '‚ôÄ', 'Saturn': '‚ôÑ', 'Rahu': '‚òä', 'Ketu': '‚òã'
            };
            
            // Current Dasa Highlight
            if (currentHighlight && currentDasa && currentDasa.mahadasa && currentDasa.bhukti) {
                currentHighlight.innerHTML = `
                    <h4 style="margin-bottom: 10px; color: #667eea;">üéØ Current Period (${new Date().getFullYear()})</h4>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">
                        ${planetEmojis[currentDasa.mahadasa.planet] || ''} Maha Dasa: ${currentDasa.mahadasa.planet} 
                        <span style="color: #666; font-weight: 400; font-size: 14px;">(${currentDasa.mahadasa.duration_years} years)</span>
                    </div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                        ${planetEmojis[currentDasa.bhukti.planet] || ''} Bhukti: ${currentDasa.bhukti.planet}
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        <strong>Age:</strong> ${currentDasa.current_age || 'N/A'} | <strong>Stage:</strong> ${currentDasa.life_stage || 'N/A'}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px; font-style: italic;">
                        ${currentDasa.prediction_note || ''}
                    </div>
                `;
            } else {
                console.log('Current dasa data incomplete or missing');
                if (currentHighlight) {
                    currentHighlight.innerHTML = '<p style="color: #666;">Current period information not available.</p>';
                }
            }
            
            // Full Timeline
            timeline.innerHTML = '';
            
            const timelineInfo = document.createElement('div');
            timelineInfo.style.cssText = 'padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;';
            timelineInfo.innerHTML = `
                <strong>Birth Dasa:</strong> ${schedule.birth_dasa} 
                <span style="color: #666;">(Balance: ${schedule.birth_dasa_balance_years} years)</span><br>
                <strong>Total Periods:</strong> ${schedule.maha_dasas.length} Maha Dasas √ó 9 Bhuktis = 81 total periods<br>
                <strong>Timeline:</strong> ${schedule.maha_dasas[0].start_date} to ${schedule.maha_dasas[schedule.maha_dasas.length - 1].end_date} (120 years)
            `;
            timeline.appendChild(timelineInfo);
            
            // Display each Maha Dasa
            if (schedule.maha_dasas && Array.isArray(schedule.maha_dasas)) {
                schedule.maha_dasas.forEach((mahaDasa, index) => {
                const dasaCard = document.createElement('details');
                dasaCard.style.cssText = `
                    margin-bottom: 15px;
                    border: 2px solid ${mahaDasa.is_birth_dasa ? '#667eea' : '#e0e0e0'};
                    border-radius: 8px;
                    padding: 15px;
                    background: ${mahaDasa.is_birth_dasa ? 'linear-gradient(135deg, #667eea11 0%, #764ba211 100%)' : 'white'};
                `;
                
                const summary = document.createElement('summary');
                summary.style.cssText = 'cursor: pointer; font-weight: 600; font-size: 16px; color: #333;';
                summary.innerHTML = `
                    ${index + 1}. ${planetEmojis[mahaDasa.dasa_lord] || ''} ${mahaDasa.dasa_lord} Maha Dasa
                    <span style="color: #666; font-weight: 400; font-size: 14px;">
                        (${mahaDasa.duration_years} years: ${mahaDasa.start_date} to ${mahaDasa.end_date})
                    </span>
                    ${mahaDasa.is_birth_dasa ? '<span style="color: #667eea;"> ‚≠ê Birth Dasa</span>' : ''}
                `;
                dasaCard.appendChild(summary);
                
                const bhuktisContainer = document.createElement('div');
                bhuktisContainer.style.cssText = 'margin-top: 15px; padding-left: 20px;';
                
                const bhuktisTitle = document.createElement('div');
                bhuktisTitle.style.cssText = 'font-weight: 600; margin-bottom: 10px; color: #667eea; font-size: 14px;';
                bhuktisTitle.textContent = `Bhuktis (Sub-Periods):`;
                bhuktisContainer.appendChild(bhuktisTitle);
                
                const bhuktisGrid = document.createElement('div');
                bhuktisGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 8px;';
                
                if (mahaDasa.bhuktis && Array.isArray(mahaDasa.bhuktis)) {
                    mahaDasa.bhuktis.forEach(bhukti => {
                    const bhuktiDiv = document.createElement('div');
                    bhuktiDiv.style.cssText = `
                        padding: 8px 12px;
                        background: ${bhukti.is_birth_bhukti ? '#764ba233' : '#f9f9f9'};
                        border-radius: 5px;
                        font-size: 12px;
                        border-left: 3px solid ${bhukti.is_birth_bhukti ? '#667eea' : '#ddd'};
                    `;
                    bhuktiDiv.innerHTML = `
                        <strong>${planetEmojis[bhukti.bhukti_lord] || ''} ${bhukti.bhukti_lord}</strong>
                        <span style="color: #666;">(${bhukti.duration_years} yrs)</span>
                        ${bhukti.is_birth_bhukti ? '<span style="color: #667eea;"> ‚≠ê</span>' : ''}<br>
                        <span style="color: #888; font-size: 11px;">${bhukti.start_date} to ${bhukti.end_date}</span>
                    `;
                    bhuktisGrid.appendChild(bhuktiDiv);
                    });
                }
                
                bhuktisContainer.appendChild(bhuktisGrid);
                dasaCard.appendChild(bhuktisContainer);
                timeline.appendChild(dasaCard);
                });
                console.log(`Displayed ${schedule.maha_dasas.length} Maha Dasas`);
            } else {
                console.log('maha_dasas array is missing or empty');
                timeline.innerHTML += '<p style="color: #f44336;">No Maha Dasa data available.</p>';
            }
            
            console.log('Dasa schedule display complete');
        }
        
        function displayFunctionalNature(functionalNature) {
            const container = document.getElementById('functional_nature');
            container.innerHTML = '';
            
            // Display categorized format (main prediction format)
            let html = `
                <div style="background: linear-gradient(135deg, #28a74522 0%, #4CAF5022 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 15px 0; color: #333;">üéØ Categorized Nature (For Predictions)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        
                        <!-- Yogakaraka -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #FFD700;">
                            <div style="font-weight: 700; font-size: 16px; color: #FFD700; margin-bottom: 10px;">
                                üëë YOGAKARAKA (Best Planet)
                            </div>
                            <div style="font-size: 18px; font-weight: 600; color: #333;">
                                ${functionalNature.yogakaraka || 'None'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${functionalNature.yogakaraka ? 'Extremely lucky! Best Dasa period' : 'No special yogakaraka for this ascendant'}
                            </div>
                        </div>
                        
                        <!-- Benefics -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">
                            <div style="font-weight: 700; font-size: 16px; color: #28a745; margin-bottom: 10px;">
                                ‚úÖ BENEFICS (Luck Bringers)
                            </div>
                            <div style="font-size: 14px; color: #333;">
                                ${functionalNature.benefics && Array.isArray(functionalNature.benefics) && functionalNature.benefics.length > 0 ? functionalNature.benefics.join(', ') : 'None'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Bring opportunities & fortune
                            </div>
                        </div>
                        
                        <!-- Malefics -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #f44336;">
                            <div style="font-weight: 700; font-size: 16px; color: #f44336; margin-bottom: 10px;">
                                ‚ö†Ô∏è MALEFICS (Trouble Makers)
                            </div>
                            <div style="font-size: 14px; color: #333;">
                                ${functionalNature.malefics && Array.isArray(functionalNature.malefics) && functionalNature.malefics.length > 0 ? functionalNature.malefics.join(', ') : 'None'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Cause challenges & obstacles
                            </div>
                        </div>
                        
                        <!-- Neutrals -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #9e9e9e;">
                            <div style="font-weight: 700; font-size: 16px; color: #9e9e9e; margin-bottom: 10px;">
                                ‚öñÔ∏è NEUTRALS (Mixed Results)
                            </div>
                            <div style="font-size: 14px; color: #333;">
                                ${functionalNature.neutrals && Array.isArray(functionalNature.neutrals) && functionalNature.neutrals.length > 0 ? functionalNature.neutrals.join(', ') : 'None'}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Context-dependent results
                            </div>
                        </div>
                        
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <strong>üí° Prediction Tip:</strong> During Dasa/Bhukti of <strong style="color: #28a745;">${functionalNature.benefics && Array.isArray(functionalNature.benefics) && functionalNature.benefics.length > 0 ? functionalNature.benefics.join(' or ') : 'benefic planets'}</strong>, expect positive results. 
                        During <strong style="color: #f44336;">${functionalNature.malefics && Array.isArray(functionalNature.malefics) && functionalNature.malefics.length > 0 ? functionalNature.malefics.join(' or ') : 'malefic planets'}</strong> periods, be cautious and proactive.
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function displayFunctionalNatureDetailed(functionalNatureDetailed) {
            const container = document.getElementById('functional_nature');
            
            const natureColors = {
                'Yogakaraka': '#28a745',
                'Functional Benefic': '#4CAF50',
                'Functional Malefic': '#f44336',
                'Mixed': '#ff9800',
                'Neutral': '#9e9e9e',
                'Neutral/Variable': '#9e9e9e'
            };
            
            const strengthEmojis = {
                '+++': 'üåü',
                '++': '‚ú®',
                '+': '‚≠ê',
                '+/-': '‚öñÔ∏è',
                '0': 'üîµ',
                '--': '‚ö†Ô∏è',
                'Depends on placement and associations': 'üîÑ'
            };
            
            let html = '<h4 style="margin: 20px 0 15px 0; color: #333;">üìä Detailed Planet-by-Planet Analysis</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
            
            if (functionalNatureDetailed && typeof functionalNatureDetailed === 'object') {
                for (const [planet, data] of Object.entries(functionalNatureDetailed)) {
                const color = natureColors[data.nature] || '#666';
                const emoji = strengthEmojis[data.strength_impact] || '';
                
                html += `
                    <div style="border: 2px solid ${color}; border-radius: 8px; padding: 15px; background: ${color}11;">
                        <div style="font-weight: 600; font-size: 16px; color: ${color}; margin-bottom: 8px;">
                            ${planet} ${emoji}
                        </div>
                        <div style="background: ${color}22; padding: 8px; border-radius: 5px; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: ${color};">
                            ${data.nature}
                        </div>
                        <div style="font-size: 13px; color: #666; margin-bottom: 6px;">
                            <strong>Houses Ruled:</strong> ${data.houses_ruled && Array.isArray(data.houses_ruled) && data.houses_ruled.length > 0 ? data.houses_ruled.join(', ') : 'None (Shadow planet)'}
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 6px; font-style: italic;">
                            ${data.reason}
                        </div>
                        <div style="font-size: 13px; font-weight: 600; color: ${color};">
                            Impact: ${data.strength_impact}
                        </div>
                    </div>
                `;
                }
            }
            
            html += '</div>';
            container.innerHTML += html;
        }
        
        function displayShadbala(shadbala) {
            console.log('displayShadbala called with:', shadbala);
            
            const container = document.getElementById('shadbala');
            if (!container) {
                console.error('Shadbala container not found');
                return;
            }
            
            container.innerHTML = '';
            
            if (!shadbala || typeof shadbala !== 'object') {
                console.error('Invalid shadbala data');
                container.innerHTML = '<p style="color: #f44336;">Shadbala data not available.</p>';
                return;
            }
            
            // Summary section
            let html = `
                <div style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Strongest</div>
                            <div style="font-size: 18px; font-weight: 600; color: #28a745;">${shadbala.strongest_planet || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Weakest</div>
                            <div style="font-size: 18px; font-weight: 600; color: #f44336;">${shadbala.weakest_planet || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Average Strength</div>
                            <div style="font-size: 18px; font-weight: 600; color: #667eea;">${shadbala.average_rupas ? shadbala.average_rupas.toFixed(2) : 'N/A'} Rupas</div>
                        </div>
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        <strong>Ranking:</strong> ${shadbala.ranking && Array.isArray(shadbala.ranking) ? shadbala.ranking.join(' ‚Üí ') : 'N/A'}
                    </div>
                    <div style="font-size: 13px; color: #666; margin-top: 8px;">
                        <strong>Strong Planets:</strong> ${shadbala.strong_planets && Array.isArray(shadbala.strong_planets) && shadbala.strong_planets.length > 0 ? shadbala.strong_planets.join(', ') : 'None'}<br>
                        <strong>Weak Planets:</strong> ${shadbala.weak_planets && Array.isArray(shadbala.weak_planets) && shadbala.weak_planets.length > 0 ? shadbala.weak_planets.join(', ') : 'None'}
                    </div>
                </div>
            `;
            
            // Individual planet strength
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
            
            if (shadbala.planets && typeof shadbala.planets === 'object') {
                for (const [planet, data] of Object.entries(shadbala.planets)) {
                    if (!data) continue;
                    
                    const percentage = data.strength_ratio || 0;
                    const barColor = data.is_strong ? '#28a745' : '#f44336';
                    const statusIcon = data.is_strong ? '‚úì' : '‚úó';
                    const statusText = data.is_strong ? 'Strong' : 'Weak';
                    
                    html += `
                        <div style="border: 2px solid ${barColor}; border-radius: 8px; padding: 15px; background: white;">
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <span>${planet}</span>
                                <span style="font-size: 14px; color: ${barColor};">${statusIcon} ${statusText}</span>
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666; margin-bottom: 4px;">
                                    <span>Total</span>
                                    <span><strong>${data.total_rupas ? data.total_rupas.toFixed(2) : 'N/A'}</strong> / ${data.required_rupas ? data.required_rupas.toFixed(2) : 'N/A'} Rupas</span>
                                </div>
                                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                                    <div style="width: ${Math.min(100, percentage)}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                                </div>
                                <div style="text-align: center; font-size: 12px; color: #666; margin-top: 4px;">
                                    ${percentage ? percentage.toFixed(1) : '0'}% of required
                                </div>
                            </div>
                            
                            <details style="font-size: 12px; color: #666;">
                                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 8px;">View Components</summary>
                                <div style="padding-left: 15px; margin-top: 8px;">
                                    <div>‚Ä¢ Sthana Bala: ${data.sthana_bala ? data.sthana_bala.toFixed(2) : 'N/A'}</div>
                                    <div>‚Ä¢ Dig Bala: ${data.dig_bala ? data.dig_bala.toFixed(2) : 'N/A'}</div>
                                    <div>‚Ä¢ Kaala Bala: ${data.kaala_bala ? data.kaala_bala.toFixed(2) : 'N/A'}</div>
                                    <div>‚Ä¢ Cheshta Bala: ${data.chesta_bala ? data.chesta_bala.toFixed(2) : 'N/A'}</div>
                                    <div>‚Ä¢ Naisargika Bala: ${data.naisargika_bala ? data.naisargika_bala.toFixed(2) : 'N/A'}</div>
                                    <div>‚Ä¢ Drik Bala: ${data.drik_bala ? data.drik_bala.toFixed(2) : 'N/A'}</div>
                                </div>
                            </details>
                        </div>
                    `;
                }
            } else {
                console.log('No planets data in shadbala');
                html += '<p style="color: #666;">No individual planet strength data available.</p>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            console.log('Shadbala display complete');
        }
        
        function showChart(chartType) {
            // Hide all charts
            ['d1', 'd2', 'd3', 'd4', 'd5', 'd6', 'd7', 'd8', 'd9', 'd10', 'd11', 'd12', 'd16', 'd20', 'd24', 'd27', 'd30', 'd40', 'd45', 'd60'].forEach(type => {
                document.getElementById(type + '_chart').style.display = 'none';
                const btn = document.getElementById('btn-' + type);
                if (btn) {
                    btn.style.background = '#f0f0f0';
                    btn.style.color = '#333';
                }
            });
            
            // Show selected chart and highlight button
            document.getElementById(chartType + '_chart').style.display = 'block';
            document.getElementById('btn-' + chartType).style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            document.getElementById('btn-' + chartType).style.color = 'white';
        }
        
        function displayHouseChart(birthChart, chartType = 'd1') {
            const chartId = 'house_chart_' + chartType;
            const houseChart = document.getElementById(chartId);
            if (!houseChart) return;
            
            houseChart.innerHTML = '';
            
            // House meanings for tooltips
            const houseMeanings = {
                1: 'Self, personality, physical body',
                2: 'Wealth, family, speech',
                3: 'Siblings, courage, communication',
                4: 'Mother, home, happiness',
                5: 'Children, creativity, romance',
                6: 'Enemies, health, service',
                7: 'Partnership, marriage, spouse',
                8: 'Longevity, transformation, occult',
                9: 'Fortune, father, dharma',
                10: 'Career, status, achievements',
                11: 'Gains, friendships, aspirations',
                12: 'Losses, spirituality, liberation'
            };
            
            // Group planets by house
            const houseData = {};
            for (let i = 1; i <= 12; i++) {
                houseData[i] = {
                    planets: [],
                    sign: ''
                };
            }
            
            // Determine which fields to use based on chart type
            let signField, signNumField;
            if (chartType === 'd2') {
                signField = 'd2_hora';
                signNumField = 'd2_num';
            } else if (chartType === 'd3') {
                signField = 'd3_drekkana';
                signNumField = 'd3_num';
            } else if (chartType === 'd4') {
                signField = 'd4_chaturthamsa';
                signNumField = 'd4_num';
            } else if (chartType === 'd5') {
                signField = 'd5_panchamsa';
                signNumField = 'd5_num';
            } else if (chartType === 'd6') {
                signField = 'd6_shashtamsa';
                signNumField = 'd6_num';
            } else if (chartType === 'd7') {
                signField = 'd7_saptamsa';
                signNumField = 'd7_num';
            } else if (chartType === 'd8') {
                signField = 'd8_ashtamsa';
                signNumField = 'd8_num';
            } else if (chartType === 'd9') {
                signField = 'd9_navamsa';
                signNumField = 'd9_num';
            } else if (chartType === 'd10') {
                signField = 'd10_dasamsa';
                signNumField = 'd10_num';
            } else if (chartType === 'd11') {
                signField = 'd11_ekadasamsa';
                signNumField = 'd11_num';
            } else if (chartType === 'd12') {
                signField = 'd12_dwadasamsa';
                signNumField = 'd12_num';
            } else if (chartType === 'd16') {
                signField = 'd16_shodasamsa';
                signNumField = 'd16_num';
            } else if (chartType === 'd20') {
                signField = 'd20_vimsamsa';
                signNumField = 'd20_num';
            } else if (chartType === 'd24') {
                signField = 'd24_chaturvimsamsa';
                signNumField = 'd24_num';
            } else if (chartType === 'd27') {
                signField = 'd27_bhamsa';
                signNumField = 'd27_num';
            } else if (chartType === 'd30') {
                signField = 'd30_trimsamsa';
                signNumField = 'd30_num';
            } else if (chartType === 'd40') {
                signField = 'd40_khavedamsa';
                signNumField = 'd40_num';
            } else if (chartType === 'd45') {
                signField = 'd45_akshavedamsa';
                signNumField = 'd45_num';
            } else if (chartType === 'd60') {
                signField = 'd60_shashtiamsa';
                signNumField = 'd60_num';
            } else {
                signField = 'rasi';
                signNumField = 'rasi_num';
            }
            
            // For D1, use houses. For divisional charts, use sign numbers
            if (chartType === 'd1') {
                // Add Lagna to house 1
                houseData[1].sign = birthChart.lagna.rasi;
                
                // Add planets to their houses
                birthChart.planets.forEach(planet => {
                    if (planet.house) {
                        houseData[planet.house].planets.push(planet.planet);
                        if (!houseData[planet.house].sign) {
                            houseData[planet.house].sign = planet.rasi;
                        }
                    }
                });
            } else {
                // For divisional charts, group by sign numbers (1-12)
                birthChart.planets.forEach(planet => {
                    const signNum = planet[signNumField];
                    let signName = planet[signField];
                    
                    // Remove Sanskrit name in parentheses if present
                    if (signName && signName.includes('(')) {
                        signName = signName.split('(')[0].trim();
                    }
                    
                    if (signNum && signNum >= 1 && signNum <= 12) {
                        houseData[signNum].planets.push(planet.planet);
                        houseData[signNum].sign = signName || `Sign ${signNum}`;
                    }
                });
            }
            
            // Create house boxes
            for (let house = 1; house <= 12; house++) {
                const houseBox = document.createElement('div');
                houseBox.style.cssText = `
                    border: 2px solid #667eea;
                    border-radius: 8px;
                    padding: 12px;
                    background: ${house === 1 && chartType === 'd1' ? 'linear-gradient(135deg, #667eea22 0%, #764ba222 100%)' : '#f9f9f9'};
                    min-height: 100px;
                    position: relative;
                    transition: transform 0.2s, box-shadow 0.2s;
                    cursor: pointer;
                `;
                
                houseBox.onmouseover = function() {
                    this.style.transform = 'translateY(-3px)';
                    this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                };
                houseBox.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                };
                
                houseBox.title = houseMeanings[house];
                
                let houseHTML = `
                    <div style="font-weight: 700; color: #667eea; margin-bottom: 5px; font-size: 14px;">
                        ${chartType === 'd1' ? 'House ' + house : houseData[house].sign || 'Sign ' + house}
                    </div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 8px;">
                        ${chartType === 'd1' ? houseMeanings[house] : ''}
                    </div>
                `;
                
                if (houseData[house].sign && chartType === 'd1') {
                    houseHTML += `
                        <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 5px;">
                            Sign: ${houseData[house].sign}
                        </div>
                    `;
                }
                
                if (house === 1 && chartType === 'd1') {
                    houseHTML += `<div style="color: #e91e63; font-weight: 600; font-size: 12px; margin-bottom: 3px;">‚Üë Lagna</div>`;
                }
                
                if (houseData[house].planets.length > 0) {
                    houseHTML += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">`;
                    houseData[house].planets.forEach(planet => {
                        const planetEmoji = {
                            'Sun': '‚òâ', 'Moon': '‚òΩ', 'Mars': '‚ôÇ', 'Mercury': '‚òø',
                            'Jupiter': '‚ôÉ', 'Venus': '‚ôÄ', 'Saturn': '‚ôÑ', 
                            'Rahu': '‚òä', 'Ketu': '‚òã'
                        };
                        houseHTML += `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                        color: white; padding: 4px 8px; border-radius: 4px; 
                                        margin: 3px 0; font-size: 11px; font-weight: 600;">
                                ${planetEmoji[planet] || ''} ${planet}
                            </div>
                        `;
                    });
                    houseHTML += `</div>`;
                }
                
                houseBox.innerHTML = houseHTML;
                houseChart.appendChild(houseBox);
            }
        }
        
        function generateReadableSummary(result) {
            const summary = document.getElementById('readable_summary');
            
            // Helper function to safely access nested properties
            const safe = (fn, fallback = 'N/A') => {
                try {
                    const value = fn();
                    return value !== undefined && value !== null ? value : fallback;
                } catch (e) {
                    return fallback;
                }
            };
            
            let html = '<div style="font-size: 14px; line-height: 1.8;">';
            
            // Personal Information
            if (result.birth_info) {
                html += `
                    <h4 style="color: #667eea; margin-top: 20px;">üë§ Personal Information</h4>
                    <p><strong>Name:</strong> ${safe(() => result.birth_info.name)}<br>
                    <strong>Birth Date:</strong> ${safe(() => result.birth_info.date)}<br>
                    <strong>Birth Time:</strong> ${safe(() => result.birth_info.time)}<br>
                    <strong>Birth Place:</strong> ${safe(() => result.birth_info.place)}<br>
                    <strong>Age:</strong> ${safe(() => result.birth_info.age)} years</p>
                `;
            }
            
            // Psychic Profile
            if (result.psychic_profile) {
                html += `
                    <h4 style="color: #667eea; margin-top: 20px;">üé≠ Psychic Profile</h4>
                    <p><strong>Title:</strong> ${safe(() => result.psychic_profile.title)}<br>
                    <strong>Description:</strong> ${safe(() => result.psychic_profile.description)}<br>
                    <strong>Channel:</strong> ${safe(() => result.psychic_profile.channel)}<br>
                    <strong>Superpower:</strong> ${safe(() => result.psychic_profile.superpower)}<br>
                    <strong>Potency:</strong> ${safe(() => result.psychic_profile.overall_potency)}%</p>
                `;
            }
            
            // Birth Chart Planets
            if (result.birth_chart && result.birth_chart.planets && result.birth_chart.planets.length > 0) {
                html += `
                    <h4 style="color: #667eea; margin-top: 20px;">üåü Birth Chart Planets</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: #f0f0f0; font-weight: 600;">
                            <td style="padding: 8px; border: 1px solid #ddd;">Planet</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">Sign</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">Nakshatra</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">Pada</td>
                        </tr>
                        ${result.birth_chart.planets.map(p => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${safe(() => p.planet)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${safe(() => p.rasi)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${safe(() => p.nakshatra)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${safe(() => p.pada)}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            // Panchang
            if (result.panchang) {
                html += `
                    <h4 style="color: #667eea; margin-top: 20px;">üìÖ Panchang</h4>
                    <p><strong>Tithi:</strong> ${safe(() => result.panchang.tithi.name)} (${safe(() => result.panchang.tithi.percentage.toFixed(1))}% complete)<br>
                    <strong>Nakshatra:</strong> ${safe(() => result.panchang.nakshatra.name)} - Pada ${safe(() => result.panchang.nakshatra.pada)}<br>
                    <strong>Yoga:</strong> ${safe(() => result.panchang.yoga.name)}<br>
                    <strong>Weekday:</strong> ${safe(() => result.panchang.weekday)} (Ruled by ${safe(() => result.panchang.weekday_planet)})</p>
                `;
            }
            
            // Current Dasa
            if (result.dasa) {
                html += `
                    <h4 style="color: #667eea; margin-top: 20px;">‚è∞ Current Dasa Period</h4>
                    <p><strong>Mahadasa:</strong> ${safe(() => result.dasa.mahadasa.planet)} (${safe(() => result.dasa.mahadasa.duration_years)} years)<br>
                    <strong>Bhukti (Antardasa):</strong> ${safe(() => result.dasa.bhukti.planet)}<br>
                    <strong>Life Stage:</strong> ${safe(() => result.dasa.life_stage)}<br>
                    <strong>Note:</strong> ${safe(() => result.dasa.prediction_note)}</p>
                `;
            }
            
            // Yogas
            if (result.yogas && result.yogas.length > 0) {
                html += `
                    <h4 style="color: #667eea; margin-top: 20px;">‚≠ê All Yogas (${result.yogas.length} total)</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: #f0f0f0; font-weight: 600;">
                            <td style="padding: 8px; border: 1px solid #ddd;">Yoga Name</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">Status</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">Nature</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">Strength</td>
                        </tr>
                        ${result.yogas.map(y => `
                            <tr style="${y.present ? 'background: #e8f5e9;' : ''}">
                                <td style="padding: 8px; border: 1px solid #ddd;">${safe(() => y.name)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${y.present ? '‚úÖ Active' : '‚ùå Inactive'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${safe(() => y.nature)}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${safe(() => y.strength, 0)}%</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            html += '</div>';
            summary.innerHTML = html;
        }
    </script>
</body>
</html>
